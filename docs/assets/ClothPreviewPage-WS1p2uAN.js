import{g as vn,a as kn,r as c,u as Cn,_ as jn,b as N,j as n,s as L,e as In,v as q,f as Sn,w as ln,x as gn,c as F,h as wn,B as A,A as Tn,T as Pn,I as G,y as Dn,i as C,C as Mn,G as D,P as nn,o as Nn,n as Rn,z as M,S as tn,E as en,D as Bn,F as $n,k as Kn,J as On,K as An}from"./index-pGr1dUQi.js";function Gn(e){return vn("MuiCircularProgress",e)}kn("MuiCircularProgress",["root","determinate","indeterminate","colorPrimary","colorSecondary","svg","circle","circleDeterminate","circleIndeterminate","circleDisableShrink"]);const qn=["className","color","disableShrink","size","style","thickness","value","variant"];let H=e=>e,an,sn,rn,cn;const d=44,Hn=gn(an||(an=H`
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
`)),_n=gn(sn||(sn=H`
  0% {
    stroke-dasharray: 1px, 200px;
    stroke-dashoffset: 0;
  }

  50% {
    stroke-dasharray: 100px, 200px;
    stroke-dashoffset: -15px;
  }

  100% {
    stroke-dasharray: 100px, 200px;
    stroke-dashoffset: -125px;
  }
`)),zn=e=>{const{classes:s,variant:h,color:g,disableShrink:j}=e,p={root:["root",h,`color${q(g)}`],svg:["svg"],circle:["circle",`circle${q(h)}`,j&&"circleDisableShrink"]};return Sn(p,Gn,s)},En=L("span",{name:"MuiCircularProgress",slot:"Root",overridesResolver:(e,s)=>{const{ownerState:h}=e;return[s.root,s[h.variant],s[`color${q(h.color)}`]]}})(({ownerState:e,theme:s})=>N({display:"inline-block"},e.variant==="determinate"&&{transition:s.transitions.create("transform")},e.color!=="inherit"&&{color:(s.vars||s).palette[e.color].main}),({ownerState:e})=>e.variant==="indeterminate"&&ln(rn||(rn=H`
      animation: ${0} 1.4s linear infinite;
    `),Hn)),Ln=L("svg",{name:"MuiCircularProgress",slot:"Svg",overridesResolver:(e,s)=>s.svg})({display:"block"}),Fn=L("circle",{name:"MuiCircularProgress",slot:"Circle",overridesResolver:(e,s)=>{const{ownerState:h}=e;return[s.circle,s[`circle${q(h.variant)}`],h.disableShrink&&s.circleDisableShrink]}})(({ownerState:e,theme:s})=>N({stroke:"currentColor"},e.variant==="determinate"&&{transition:s.transitions.create("stroke-dashoffset")},e.variant==="indeterminate"&&{strokeDasharray:"80px, 200px",strokeDashoffset:0}),({ownerState:e})=>e.variant==="indeterminate"&&!e.disableShrink&&ln(cn||(cn=H`
      animation: ${0} 1.4s ease-in-out infinite;
    `),_n)),Un=c.forwardRef(function(s,h){const g=Cn({props:s,name:"MuiCircularProgress"}),{className:j,color:p="primary",disableShrink:U=!1,size:x=40,style:V,thickness:b=3.6,value:v=0,variant:I="indeterminate"}=g,u=jn(g,qn),f=N({},g,{color:p,disableShrink:U,size:x,thickness:b,value:v,variant:I}),i=zn(f),S={},w={},R={};if(I==="determinate"){const k=2*Math.PI*((d-b)/2);S.strokeDasharray=k.toFixed(3),R["aria-valuenow"]=Math.round(v),S.strokeDashoffset=`${((100-v)/100*k).toFixed(3)}px`,w.transform="rotate(-90deg)"}return n.jsx(En,N({className:In(i.root,j),style:N({width:x,height:x},w,V),ownerState:f,ref:h,role:"progressbar"},R,u,{children:n.jsx(Ln,{className:i.svg,ownerState:f,viewBox:`${d/2} ${d/2} ${d} ${d}`,children:n.jsx(Fn,{className:i.circle,style:S,ownerState:f,cx:d,cy:d,r:(d-b)/2,fill:"none",strokeWidth:b})})}))}),Vn=F(n.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Wn=F(n.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"}),"Link"),on=F(n.jsx("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh"),hn="AIzaSyAQYbMv776R52W-qz-80ywInejsHkxNUIU",Xn=()=>{const e=wn(),[s,h]=c.useState(null),[g,j]=c.useState(null),[p,U]=c.useState(null),[x,V]=c.useState(null),[b,v]=c.useState([]),[I,u]=c.useState(!1),[f,i]=c.useState(null),[S,w]=c.useState(!1),[R,k]=c.useState(!1),[mn,un]=c.useState(""),[_,B]=c.useState(0),[W,$]=c.useState(!1),[dn,J]=c.useState("");c.useEffect(()=>{const a=localStorage.getItem("croppedClothImage");h(a);const t=localStorage.getItem("savedModels"),r=localStorage.getItem("selectedModelId");if(t&&r){const l=JSON.parse(t).find(o=>o.id===r);l&&j(l.image)}},[]),c.useEffect(()=>{let a;return _>0&&(a=setInterval(()=>{B(t=>t<=1?($(!1),clearInterval(a),0):t-1)},1e3)),()=>{a&&clearInterval(a)}},[_]);const X=async(a,t)=>{if(!a)return i(`Không tìm thấy ảnh ${t==="cloth"?"trang phục":"người mẫu"}`),null;u(!0),i(null);try{const m=await(await fetch(a)).blob(),l=new FormData;l.append("method","basnet"),l.append("file",m);const o=new AbortController,y=setTimeout(()=>o.abort(),15e3),P=await fetch("https://bgbye1.fyrean.com/remove_background/",{method:"POST",body:l,signal:o.signal});if(clearTimeout(y),!P.ok)throw new Error(`Không thể xóa phông nền cho ${t==="cloth"?"trang phục":"người mẫu"}`);const K=await P.blob(),Z=URL.createObjectURL(K),O=new FileReader;return O.onloadend=()=>{localStorage.setItem(`processed${t==="cloth"?"ClothImage":"ModelImage"}`,O.result)},O.readAsDataURL(K),Z}catch(r){return r.name==="AbortError"?(console.error(`Timeout: ${t==="cloth"?"trang phục":"người mẫu"} ảnh gốc được trả về.`),i(`Timeout: ${t==="cloth"?"trang phục":"người mẫu"} ảnh gốc được trả về.`),a):(console.error(`Lỗi xóa phông nền cho ${t==="cloth"?"trang phục":"người mẫu"}:`,r),i(`Không thể xóa phông nền cho ${t==="cloth"?"trang phục":"người mẫu"}. Vui lòng thử lại.`),null)}finally{u(!1)}},pn=async()=>{v([]),u(!0),$(!0),B(80);try{if(!s||!g)throw new Error("Thiếu ảnh trang phục hoặc người mẫu");J("Đang xóa phông...");const[a,t]=await Promise.all([X(s,"cloth"),X(g,"model")]);J("Đang mặc thử đồ...");const r=[T(a,t),T(a,t),T(a,t),T(a,t),T(a,t)];(await Promise.all(r)).some(o=>o)||(i("Không thể tạo ảnh thử đồ. Vui lòng thử lại sau."),u(!1),$(!1),B(0))}catch(a){console.error("Lỗi khi gọi Gemini API:",a),$(!1),B(0),i("Không thể tạo ảnh thử đồ. Vui lòng thử lại sau.")}},xn=()=>{e("/clothes/crop")},Q=()=>{i(null)},T=async(a,t)=>{if(!a||!t)return i("Vui lòng xóa phông cả trang phục và người mẫu trước"),!1;u(!0),i(null);try{const r=await Y(a),m=await Y(t);let o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent?key=${hn}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`
Hãy tự phát hiện và gán hai hình ảnh như sau:

Ảnh 1: Trang phục
Đặc điểm: Bức ảnh không có người, chỉ có trang phục hoặc có người mặc nhưng không hiển thị đủ đầu, tay, chân của người mặc. Trang phục có thể được đặt trên một bề mặt phẳng (như bàn, sàn) hoặc treo trên mắc áo.
Cách nhận biết: Tìm bức ảnh không có người mẫu xuất hiện hoàn chỉnh. Nếu chỉ thấy quần áo mà không có ai mặc hoặc có người mặc nhưng không hiển thị đủ đầu, tay, chân, đó chính là ảnh trang phục.
Ảnh 2: Người mẫu
Đặc điểm: Bức ảnh có người mẫu hiển thị đủ đầu, tay, chân, nhưng người mẫu không mặc trang phục giống với trang phục trong ảnh trang phục. Người mẫu có thể mặc trang phục khác (như đồ lót, trang phục nền) hoặc không mặc gì (tùy ngữ cảnh, thường là trang phục tối giản trong ứng dụng thử đồ ảo).
Cách nhận biết: Sau khi xác định ảnh trang phục, trong hai bức ảnh còn lại, tìm bức ảnh có người mẫu nhưng trang phục trên người mẫu khác với trang phục trong ảnh trang phục. Đó là ảnh người mẫu.
Mô tả các bước ghép trang phục từ ảnh 2 vào người mẫu của ảnh 1:

Bước 1: Xác định vị trí và kích thước của người mẫu trong ảnh 1.
Bước 2: Cắt trang phục từ ảnh 2.
Bước 3: Điều chỉnh kích thước và vị trí của trang phục sao cho phù hợp với người mẫu trong ảnh 1.
Bước 4: Ghép trang phục đã cắt vào người mẫu trong ảnh 1.
Bước 5: Điều chỉnh màu sắc và ánh sáng của trang phục để hòa hợp tự nhiên với ảnh 1.
Tạo ảnh dựa trên mô tả:

Thực hiện các bước ghép ảnh theo hướng dẫn trên để tạo ra một bức ảnh mới, trong đó người mẫu trong ảnh 1 mặc trang phục từ ảnh 2.
`},{inlineData:{mimeType:"image/png",data:r}},{inlineData:{mimeType:"image/png",data:m}}]}],generationConfig:{temperature:.1,topK:10,topP:.9,maxOutputTokens:1e4,responseModalities:["Text","Image"]}})}),y=await o.json();const P=y.candidates[0].content.parts.find(E=>E.inlineData).inlineData.data,K=`data:image/png;base64,${P}`;return o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent?key=${hn}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`
Hãy tự động gán nhãn cho ba hình ảnh theo các vai trò sau: Ảnh Trang phục, Ảnh Người mẫu, và Ảnh Kết quả.

Mô tả các loại ảnh
Ảnh Trang phục
Đặc điểm: Bức ảnh chỉ có trang phục, không có người mẫu hoàn chỉnh (hoặc có người nhưng không hiển thị đủ đầu, tay, chân). Trang phục có thể được đặt trên bề mặt phẳng (như bàn, sàn) hoặc treo trên mắc áo.
Cách nhận biết: Tìm bức ảnh không có người mẫu đầy đủ. Nếu chỉ thấy quần áo hoặc người mặc thiếu các bộ phận cơ thể (đầu, tay, chân), đó là Ảnh Trang phục.
Ảnh Người mẫu
Đặc điểm: Bức ảnh có người mẫu hiển thị đầy đủ đầu, tay, chân, nhưng không mặc trang phục giống với Ảnh Trang phục. Người mẫu có thể mặc trang phục khác (như đồ lót, trang phục nền) hoặc trang phục tối giản (tùy ngữ cảnh).
Cách nhận biết: Trong hai bức ảnh có người mẫu đầy đủ, ảnh nào có trang phục khác với Ảnh Trang phục, đó là Ảnh Người mẫu.
Ảnh Kết quả
Đặc điểm: Bức ảnh có người mẫu mặc trang phục giống hệt với Ảnh Trang phục, và trang phục được ghép vào bằng chỉnh sửa ảnh.
Cách nhận biết: Trong hai bức ảnh có người mẫu đầy đủ, ảnh nào có trang phục trùng khớp với Ảnh Trang phục, đó là Ảnh Kết quả. (Nếu cần, có thể kiểm tra dấu hiệu chỉnh sửa như viền không tự nhiên hoặc ánh sáng không đồng đều, nhưng không bắt buộc nếu trang phục đã rõ ràng giống nhau).
Quy trình gán nhãn
Bước 1: Xác định bức ảnh chỉ có trang phục hoặc không có người mẫu hoàn chỉnh (hoặc thiếu đầu, tay, chân) – đó là Ảnh Trang phục.
Bước 2: Với hai bức ảnh còn lại (có người mẫu đầy đủ), so sánh trang phục:
Nếu trang phục khác với Ảnh Trang phục, đó là Ảnh Người mẫu.
Nếu trang phục giống với Ảnh Trang phục, đó là Ảnh Kết quả.
Kết quả gán nhãn: Xác định rõ vai trò của từng ảnh theo thứ tự: Ảnh 1 là Trang phục, Ảnh 2 là Người mẫu, Ảnh 3 là Kết quả.
Đánh giá Ảnh Kết quả
Sau khi gán nhãn, hãy kiểm tra xem Ảnh Kết quả có thỏa mãn tất cả các điều kiện sau không:

Người trong Ảnh Kết quả có mặc trang phục giống y hệt với Ảnh Trang phục hay không.
Người trong Ảnh Kết quả có phải là cùng một người với người trong Ảnh Người mẫu hay không.
Trang phục trong Ảnh Kết quả có được mặc một cách tự nhiên và hài hòa hay không (không có dấu hiệu ghép ảnh quá lộ liễu).
Trả lời:
"Đúng" nếu tất cả ba điều kiện đều được thỏa mãn.
"Sai" nếu bất kỳ điều kiện nào không được thỏa mãn.`},{inlineData:{mimeType:"image/png",data:r}},{inlineData:{mimeType:"image/png",data:m}},{inlineData:{mimeType:"image/png",data:P}}]}],generationConfig:{temperature:.1,topK:10,topP:.9,maxOutputTokens:1e4,responseModalities:["Text","Image"]}})}),y=await o.json(),y.candidates[0].content.parts[0].text.includes("Đúng")?(v(E=>[...E,K]),w(!0),u(!1),!0):!1}catch(r){return console.error("Lỗi gọi Gemini API:",r),!1}},Y=async a=>{const r=await(await fetch(a)).blob();return new Promise((m,l)=>{const o=new FileReader;o.onloadend=()=>{const y=o.result.split(",")[1];m(y)},o.onerror=l,o.readAsDataURL(r)})},fn=a=>{const t=localStorage.getItem("tryOnHistory"),r=t?JSON.parse(t):[],m={id:`tryOn_${Date.now()}`,clothImage:p||"",modelImage:x||"",generatedImage:a,timestamp:Date.now()};r.unshift(m);const l=r.slice(0,20);localStorage.setItem("tryOnHistory",JSON.stringify(l)),k(!0),un("Ảnh đã được lưu vào lịch sử thử đồ")},z=()=>{w(!1)},yn=()=>{e("/clothes")},bn=()=>{e("/models")};return n.jsxs(A,{sx:{display:"flex",flexDirection:"column",height:"100vh",bgcolor:"#f5f5f7"},children:[n.jsx(Tn,{position:"static",elevation:0,sx:{bgcolor:"white",color:"text.primary"},children:n.jsxs(Pn,{sx:{minHeight:{xs:"56px"}},children:[n.jsx(G,{edge:"start",color:"inherit","aria-label":"back",sx:{mr:2},onClick:xn,children:n.jsx(Dn,{})}),n.jsx(C,{variant:"h6",component:"div",sx:{flexGrow:1,fontWeight:600,fontSize:{xs:"1.1rem",sm:"1.25rem"}},children:"Xem trước thử đồ"})]})}),n.jsxs(Mn,{sx:{flexGrow:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:3},children:[n.jsxs(D,{container:!0,spacing:2,sx:{maxWidth:600,width:"100%"},children:[n.jsx(D,{item:!0,xs:6,children:n.jsxs(nn,{elevation:3,sx:{height:"100%",display:"flex",flexDirection:"column",alignItems:"center",p:2,borderRadius:3},children:[n.jsxs(C,{variant:"subtitle1",sx:{mb:2,display:"flex",alignItems:"center"},children:[n.jsx(Nn,{sx:{mr:1}})," Trang phục"]}),p?n.jsx("img",{src:p,alt:"Processed cloth",style:{width:"100%",aspectRatio:"1/1",objectFit:"cover",borderRadius:16}}):s?n.jsx("img",{src:s,alt:"Cropped cloth",style:{width:"100%",aspectRatio:"1/1",objectFit:"cover",borderRadius:16}}):n.jsx(C,{color:"text.secondary",children:"Chưa có ảnh"}),n.jsx(G,{color:"inherit","aria-label":"change clothes",onClick:yn,children:n.jsx(on,{})})]})}),n.jsx(D,{item:!0,xs:6,children:n.jsxs(nn,{elevation:3,sx:{height:"100%",display:"flex",flexDirection:"column",alignItems:"center",p:2,borderRadius:3},children:[n.jsxs(C,{variant:"subtitle1",sx:{mb:2,display:"flex",alignItems:"center"},children:[n.jsx(Rn,{sx:{mr:1}})," Người mẫu"]}),x?n.jsx("img",{src:x,alt:"Processed model",style:{width:"100%",aspectRatio:"1/1",objectFit:"cover",borderRadius:16}}):g?n.jsx("img",{src:g,alt:"Selected model",style:{width:"100%",aspectRatio:"1/1",objectFit:"cover",borderRadius:16}}):n.jsx(C,{color:"text.secondary",children:"Chưa chọn người mẫu"}),n.jsx(G,{color:"inherit","aria-label":"change clothes",onClick:bn,children:n.jsx(on,{})})]})})]}),I&&n.jsxs(A,{sx:{position:"fixed",top:0,left:0,width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(0,0,0,0.5)",zIndex:9999},children:[n.jsx(Un,{}),n.jsx(C,{variant:"h6",sx:{color:"white",mt:2},children:dn||"Đang mặc thử đồ..."})]}),n.jsxs(A,{display:"flex",justifyContent:"space-between",mt:2,children:[n.jsx(M,{variant:"outlined",onClick:()=>e("/"),children:"Trang chủ"}),n.jsx(M,{variant:"contained",color:"primary",onClick:pn,disabled:I||W,sx:{ml:2},children:W?`Thử đồ (${_}s)`:"Thử đồ"})]}),n.jsx(tn,{open:!!f,autoHideDuration:6e3,onClose:Q,children:n.jsx(en,{onClose:Q,severity:"error",sx:{width:"100%"},children:f})})]}),n.jsxs(Bn,{open:S,onClose:z,maxWidth:"md",fullWidth:!0,children:[n.jsxs($n,{children:["Đã thử đồ xong ^^",n.jsx(G,{"aria-label":"close",onClick:z,sx:{position:"absolute",right:8,top:8},children:n.jsx(Vn,{})})]}),n.jsx(Kn,{children:n.jsx(D,{container:!0,spacing:2,children:b.map((a,t)=>n.jsxs(D,{item:!0,xs:12,sm:6,children:[n.jsx("img",{src:a,alt:`AI Generated ${t+1}`,style:{width:"100%",height:"auto",objectFit:"contain",borderRadius:"8px"}}),n.jsxs(A,{sx:{mt:1,display:"flex",justifyContent:"center",gap:1},children:[n.jsx(M,{startIcon:n.jsx(Wn,{}),size:"small",children:"Chia sẻ"}),n.jsx(M,{startIcon:n.jsx(On,{}),onClick:()=>fn(a),size:"small",children:"Lưu"})]})]},t))})}),n.jsx(An,{children:n.jsx(M,{onClick:z,children:"Đóng"})})]}),n.jsx(tn,{open:R,autoHideDuration:6e3,onClose:()=>k(!1),children:n.jsx(en,{onClose:()=>k(!1),severity:"success",sx:{width:"100%"},children:mn})})]})};export{Xn as default};
